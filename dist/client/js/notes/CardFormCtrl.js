angular.module("oto").controller("CardFormCtrl",["$scope","$filter","$http","Auth","Stacks","Cards","FileUploader",function(a,b,c,d,e,f,g){function h(){if(f.cardFormCard){if(a.countUploads>0||a.saving)return void(f.cardFormCard=null);a.loadedCard=angular.copy(f.cardFormCard),a.loadedCard.duedate&&(a.loadedCard.duedate=a.loadedCard.duedate.substring(0,10)),"new"==a.loadedCard._id.substring(0,3)?a.cardFormAction="new":a.cardFormAction="edit"}}function i(){a.cardFormAction="new",fileAttachmentsAdded=[],fileAttachmentsRemoved=[],urlAttachmentsAdded=[],urlAttachmentsRemoved=[],a.attachmentsChanged=!1,a.isLinkInputVisible=!1,a.linkInputValue="http://www.google.com",a.titleError=!1,a.titleErrorMessage="",a.loadedCard=_.clone(k),a.isLinkInputVisible=!1,a.saving=!1,a.countUploads=0,a.progressByPosition=[],a.progressByPositionUrl=[],l&&l(),$("#duedate").val("")}function j(b,d){b.length>0&&c({method:"POST",url:"/api/notes/deleteatts",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param({cardid:a.loadedCard._id,array:JSON.stringify(b),changeModifiedat:!1})}),d.length>0&&c({method:"POST",url:"/api/notes/deletelinks",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param({cardid:a.loadedCard._id,array:JSON.stringify(d),changeModifiedat:!1})})}var k={title:"",content:"",duedate:"",fileattachments:[],urlattachments:[]},l=null;a.Cards=f,a.showForm=!1,a.$watch("Cards.showForm",function(b){a.showForm=b,b?h():i()}),a.doCardFormAction=function(){a.cardForm.$invalid||(a.countUploads>0?l=a.$watch("countUploads",function(b,c){0===b&&c>0&&("edit"==a.cardFormAction?n():m())}):"edit"==a.cardFormAction?n():m())};var m=function(){a.saving=!0;var d=a.loadedCard,g=a.loadedCard._id;d.stackid=e.activeStack._id,d.clientid=g,d.createdat=getDateWithTime(),d.modifiedat=getDateWithTime(),""==d.duedate&&(d.duedate=null),f.cards.push(d),c({method:"POST",url:"/api/notes/cards/",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param({card:d,fileattachments:JSON.stringify(d.fileattachments),urlattachments:JSON.stringify(d.urlattachments),clientid:g})}).success(function(c){var d=b("filter")(f.cards,{clientid:c.clientid});1===d.length?(d[0]._id=c.card._id,d[0].createdat=c.card.createdat,d[0].modifiedat=c.card.modifiedat,f.showForm=!1,a.saving=!1):(console.error(d),alert("Error saving card:"+c.card._id))}).error(function(a){console.error(a)})},n=function(){if(!a.cardForm.$invalid){a.saving=!0;var d=[];jQuery.each(fileAttachmentsAdded,function(a,b){fileAttachmentsRemoved.indexOf(b)>-1&&d.indexOf(b)==-1&&d.push(b)}),d=d.concat(fileAttachmentsRemoved),d.length>0&&c({method:"POST",url:"/api/notes/deleteatts",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param({cardid:a.loadedCard._id,array:JSON.stringify(d)})});var e=[];jQuery.each(urlAttachmentsAdded,function(a,b){urlAttachmentsRemoved.indexOf(b)>-1&&e.indexOf(b)==-1&&e.push(b)}),e=e.concat(urlAttachmentsRemoved),e.length>0&&c({method:"POST",url:"/api/notes/deletelinks",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param({cardid:a.loadedCard._id,array:JSON.stringify(e)})});var g=a.loadedCard;g.clientid=a.loadedCard._id,g.modifiedat=getDateWithTime(),""==g.duedate&&(g.duedate=null),_.extend(f.cardFormCard,g),c.put("/api/notes/cards/"+g._id,g).success(function(c){var d=b("filter")(f.cards,{_id:c._id});1===d.length?(f.cards[f.cards.indexOf(d[0])]=c,f.showForm=!1,a.saving=!1):(console.error(found),alert("Error saving card:"+card._id))}).error(function(a){console.error(a)})}};a.cancelCardForm=function(){if(f.showForm=!1,"edit"===a.cardFormAction){var b=[];jQuery.each(fileAttachmentsAdded,function(a,c){fileAttachmentsRemoved.indexOf(c)>-1&&b.indexOf(c)==-1&&b.push(c)}),b=b.concat(fileAttachmentsAdded);var c=[];jQuery.each(urlAttachmentsAdded,function(a,b){urlAttachmentsRemoved.indexOf(b)>-1&&c.indexOf(b)==-1&&c.push(b)}),c=c.concat(urlAttachmentsAdded),j(b,c)}else j(fileAttachmentsAdded,urlAttachmentsAdded)},a.isSaveDisabled=function(){return"edit"===a.cardFormAction?!!a.cardForm.$invalid||(!!(a.countUploads>0||a.saving)||(a.attachmentsChanged!==!0||!angular.equals(a.loadedCard,f.cardFormCard))&&(!(a.attachmentsChanged===!1&&!angular.equals(a.loadedCard,f.cardFormCard))&&!(a.attachmentsChanged===!0&&!angular.equals(a.loadedCard,f.cardFormCard)))):a.cardForm.$invalid},a.isLinkInputValueInvalid=function(){return!a.linkInputValue},a.attThumbSrc=function(a){return a.image?a.image.thumb.defaultUrl:a.pdf?a.pdf.thumb.defaultUrl:a.urlThumb?a.urlThumb:"/img/nothumb.png"};var o=a.uploader=new g({url:"/upload",autoUpload:!0,removeAfterUpload:!0,scope:a,headers:{"X-XSRF-TOKEN":d.xsrfToken}});o.onAfterAddingFile=function(b){var c=a.loadedCard._id,d=a.loadedCard.fileattachments.length,e={filename:b.file.name,cardid:c,position:d};b.formData=[{cardid:c,att:JSON.stringify(e)}],a.loadedCard.fileattachments[d]=e,a.progressByPosition[d]="init",a.countUploads++,a.$apply()},o.onProgressItem=function(b,c){var d=JSON.parse(b.formData[0].att),e=d.position;a.progressByPosition[e]=c,"100"==c&&(a.progressByPosition[e]="storing"),a.$apply()},o.onSuccessItem=function(b,c){a.loadedCard.fileattachments[c.position]=c,fileAttachmentsAdded.push(c._id),a.progressByPosition[c.position]=null,a.attachmentsChanged=!0,a.countUploads--,a.$apply()},o.onCancelItem=function(a,b,c,d){},o.onErrorItem=function(b,c,d,e){console.error("Error",xhr,b,c);var f=JSON.parse(b.formData[0].att);f=f.position,a.progressByPosition[f]="error",a.countUploads--},o.onCompleteItem=function(a,b,c,d){},a.removeAtt=function(b){fileAttachmentsRemoved.push(b._id),a.loadedCard.fileattachments.splice(a.loadedCard.fileattachments.indexOf(b),1),a.attachmentsChanged=!0},a.initAddLink=function(){a.isLinkInputVisible=!0},a.cancelAddLink=function(){a.isLinkInputVisible=!1,a.linkInputValue=""},a.addLink=function(){a.isLinkInputVisible=!1;var b=a.loadedCard._id,d=a.loadedCard.urlattachments.length,e={url:a.linkInputValue,cardid:b,position:d};a.loadedCard.urlattachments[d]=e,a.progressByPositionUrl[d]="init",a.countUploads++,c({method:"POST",url:"/api/notes/addlink",type:"JSON",data:{cardid:b,att:JSON.stringify(e)}}).success(function(b,c,d,e){urlAttachmentsAdded.push(b._id),a.loadedCard.urlattachments[b.position]=b,a.progressByPositionUrl[b.position]=null,a.attachmentsChanged=!0,a.countUploads--}).error(function(a){console.error(a)})},a.removeLink=function(b){urlAttachmentsRemoved.push(b._id),a.loadedCard.urlattachments.splice(a.loadedCard.urlattachments.indexOf(b),1),a.attachmentsChanged=!0}}]);